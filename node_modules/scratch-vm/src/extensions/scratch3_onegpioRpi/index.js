/*
This is the Scratch 3 extension to remotely control an
Arduino Uno, ESP-8666, or Raspberry Pi


 Copyright (c) 2019 Alan Yorinks All rights reserved.

 This program is free software; you can redistribute it and/or
 modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
 Version 3 as published by the Free Software Foundation; either
 or (at your option) any later version.
 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 General Public License for more details.

 You should have received a copy of the GNU AFFERO GENERAL PUBLIC LICENSE
 along with this library; if not, write to the Free Software
 Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 */

// Boiler plate from the Scratch Team
const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const formatMessage = require('format-message');

require('sweetalert');

// The following are constants used within the extension

// Digital Modes
const DIGITAL_INPUT = 1;
const DIGITAL_OUTPUT = 2;
const PWM = 3;
const SERVO = 4;
const TONE = 5;
const SONAR = 6;
const ANALOG_INPUT = 7;

// an array to save the current pin mode
// this is common to all board types since it contains enough
// entries for all the boards.
// Modes are listed above - initialize to invalid mode of -1
let pin_modes = new Array(30).fill(-1);

// has an websocket message already been received
let alerted = false;

let connection_pending = false;

// general outgoing websocket message holder
let msg = null;

// the pin assigned to the sonar trigger
// initially set to -1, an illegal value
let sonar_report_pin = -1;

// flag to indicate if the user connected to a board
let connected = false;

// arrays to hold input values
let digital_inputs = new Array(32);
let analog_inputs = new Array(8);

// flag to indicate if a websocket connect was
// ever attempted.
let connect_attempt = false;

// an array to buffer operations until socket is opened
let wait_open = [];

let the_locale = null;

let ws_ip_address = '127.0.0.1';

// common

const FormDigitalWrite = {
    'pt-br': 'Definir Pino Digital[PIN]como[ON_OFF]',
    'pt': 'Definir Pino Digital[PIN]como[ON_OFF]',
    'en': 'Write Digital Pin [PIN] [ON_OFF]',
    'fr': 'Mettre la pin numérique[PIN]à[ON_OFF]',
    'zh-tw': '腳位[PIN]數位輸出[ON_OFF]',
    'zh-cn': '脚位[PIN]数位输出[ON_OFF]',
};

const FormPwmWrite = {
    'pt-br': 'Definir Pino PWM[PIN]com[VALUE]%',
    'pt': 'Definir Pino PWM[PIN]com[VALUE]%',
    'en': 'Write PWM Pin [PIN] [VALUE]%',
    'fr': 'Mettre la pin PWM[PIN]à[VALUE]%',
    'zh-tw': '腳位[PIN]類比輸出[VALUE]%',
    'zh-cn': '脚位[PIN]类比输出[VALUE]%',
};

const FormTone = {
    'pt-br': 'Definir Buzzer no Pino[PIN]com[FREQ]Hz e[DURATION]ms',
    'pt': 'Definir Buzzer no Pino[PIN]com[FREQ]Hz  e[DURATION]ms',
    'en': 'Tone Pin [PIN] [FREQ] Hz [DURATION] ms',
    'fr': 'Définir le buzzer sur la pin[PIN]à[FREQ]Hz pendant[DURATION] ms',
    'zh-tw': '腳位[PIN]播放音調，頻率為[FREQ]時間為[DURATION]',
    'zh-cn': '脚位[PIN]播放音调，频率为[FREQ]时间为[DURATION]',
};

const FormServo = {
    'pt-br': 'Mover Servo Motor no[PIN]para[ANGLE]°',
    'pt': 'Mover Servo Motor no[PIN]para[ANGLE]°',
    'en': 'Write Servo Pin [PIN] [ANGLE] Deg.',
    'fr': 'Mettre le servo[PIN]à[ANGLE] Deg.',
    'zh-tw': '伺服馬達腳位[PIN]轉動角度到[ANGLE]度',
    'zh-cn': '伺服马达脚位[PIN]转动角度到[ANGLE]度',

};

const FormAnalogRead = {
    'pt-br': 'Ler Pino Analógico [PIN]',
    'pt': 'Ler Pino Analógico [PIN]',
    'en': 'Read Analog Pin [PIN]',
    'fr': 'Lecture analogique [PIN]',
    'zh-tw': '讀取類比腳位[PIN]',
    'zh-cn': '读取类比脚位[PIN]',

};

const FormDigitalRead = {
    'pt-br': 'Ler Pino Digital [PIN]',
    'pt': 'Ler Pino Digital [PIN]',
    'en': 'Read Digital Pin [PIN]',
    'fr': 'Lecture numérique [PIN]',
    'zh-tw': '讀取數位腳位[PIN]',
    'zh-cn': '读取数位脚位[PIN]',
};

const FormSonarRead = {
    'pt-br': 'Ler Distância: Sonar em T[TRIGGER_PIN] E[ECHO_PIN]',
    'pt': 'Ler Distância: Sonar em T[TRIGGER_PIN] E[ECHO_PIN]',
    'en': 'Read SONAR  T [TRIGGER_PIN]  E [ECHO_PIN]',
    'fr': 'Distance de lecture : Sonar T [TRIGGER_PIN] E [ECHO_PIN]',
    'zh-tw': 'HCSR超音波感測器，Echo在腳位[ECHO_PIN]Trig在腳位[TRIGGER_PIN]',
    'zh-cn': 'HCSR超音波感测器，Echo在脚位[ECHO_PIN]Trig在脚位[TRIGGER_PIN]',
};

// ESP-8266 specific

const FormIPBlockE = {
    'pt-br': 'Endereço IP da placa ESP-8266 [IP_ADDR]',
    'pt': 'Endereço IP da placa ESP-8266 [IP_ADDR]',
    'en': 'ESP-8266 IP Address [IP_ADDR]',
    'fr': "Adresse IP de l'ESP-8266 [IP_ADDR]",
    'zh-tw': 'ESP-8266 IP 位址[IP_ADDR]',
    'zh-cn': 'ESP-8266 IP 地址[IP_ADDR]',
};


// Raspbery Pi Specific
const FormIPBlockR = {
    'pt-br': 'Endereço IP do RPi [IP_ADDR]',
    'pt': 'Endereço IP do RPi [IP_ADDR]',
    'en': 'Remote IP Address [IP_ADDR]',
    'fr': 'Adresse IP du RPi [IP_ADDR]',
    'zh-tw': '遠端 IP 位址[IP_ADDR]',
    'zh-cn': '远程 IP 地址[IP_ADDR]',
};

// General Alert
const FormWSClosed = {
    'pt-br': "A Conexão do WebSocket está Fechada",
    'pt': "A Conexão do WebSocket está Fechada",
    'en': "WebSocket Connection Is Closed.",
    'fr': "La connexion WebSocket est fermée.",
    'zh-tw': "網路連線中斷",
    'zh-cn': "网絡连线中断",
};

// ESP-8266 Alert
const FormAlrt = {
    'pt-br': {
        title: "Atenção",
        text: "Informe o endereço IP da placa ESP-8266 no bloco apropriado",
        icon: "info",
    },
    'pt': {
        title: "Atenção",
        text: "Informe o endereço IP da placa ESP-8266 no bloco apropriado",
        icon: "info",
    },
    'en': {
        title: "Reminder",
        text: "Enter the IP Address of the ESP-8266 Into The IP Address Block",
        icon: "info",
    },
    'fr': {
        title: "Attention",
        text: "Entrez l'adresse IP de l'ESP-8266 dans le bloc approprié.",
        icon: "info",
    },
    'zh-tw': {
        title: "提醒",
        text: "請於 IP 位址積木中輸入 ESP-8266 的 IP 位址",
        icon: "資訊",
    },
    'zh-cn': {
        title: "提醒",
        text: "请于 IP 位址积木中输入 ESP-8266 的 IP 地址",
        icon: "资讯",
    },
};


class Scratch3RpiOneGPIO {
    constructor(runtime) {
        the_locale = this._setLocale();
        this.runtime = runtime;
    }

    getInfo() {
        the_locale = this._setLocale();
        //this.connect();

        return {
            id: 'onegpioRpi',
            color1: '#0C5986',
            color2: '#34B0F7',
            name: 'OneGpio Raspberry Pi',
            blockIconURI: 'data:image/png;base64,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',
            blocks: [
                {
                    opcode: 'ip_address',
                    blockType: BlockType.COMMAND,
                    //text: 'Write Digital Pin [PIN] [ON_OFF]',
                    text: FormIPBlockR[the_locale],

                    arguments: {
                        IP_ADDR: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '',
                            //menu: "digital_pins"
                        },

                    }

                },
                {
                    opcode: 'digital_write',
                    blockType: BlockType.COMMAND,
                    text: FormDigitalWrite[the_locale],

            arguments: {
                        PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '4',
                            menu: "digital_pins"
                        },
                        ON_OFF: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '0',
                            menu: "on_off"
                        }
                    }
                },
                {
                    opcode: 'pwm_write',
                    blockType: BlockType.COMMAND,
                    text: FormPwmWrite[the_locale],
                    arguments: {
                        PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '4',
                            menu: 'pwm_pins'
                        },
                        VALUE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '50',
                        }
                    }
                },
                '---',
                {
                    opcode: 'tone_on',
                    blockType: BlockType.COMMAND,
                    text: FormTone[the_locale],
                    arguments: {
                        PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '4',
                            menu: 'digital_pins'
                        },
                        FREQ: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 100,
                        },
                        DURATION: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 50,
                        }
                    }
                },

                '---',
                {
                    opcode: 'servo',
                    blockType: BlockType.COMMAND,
                    text: FormServo[the_locale],
                    arguments: {
                        PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '4',
                            menu: 'digital_pins'
                        },
                        ANGLE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 90,
                        },

                    }
                },

                '---',
                {
                    opcode: 'digital_read',
                    blockType: BlockType.REPORTER,
                    text: FormDigitalRead[the_locale],
                    arguments: {
                        PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '4',
                            menu: 'digital_pins'
                        },
                    }
                },
                '---',
                {
                    opcode: 'sonar_read',
                    blockType: BlockType.REPORTER,
                    text: FormSonarRead[the_locale],

            arguments: {
                        TRIGGER_PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '4',
                            menu: 'digital_pins'
                        },
                        ECHO_PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '5',
                            menu: 'digital_pins'
                        }
                    }
                },
            ],
            menus: {
                digital_pins: {
                    acceptReporters: true,
                    items: ['2', '3', '4', '5', '6', '7', '8', '9',
                        '10', '11', '12', '13', '14', '15', '16',
                        '17', '18', '19', '20',
                        '21', '22', '23', '24', '25', '26', '27']
                },
                pwm_pins: {
                    acceptReporters: true,
                    items: ['2', '3', '4', '5', '6', '7', '8', '9',
                        '10', '11', '12', '13', '14', '15', '16',
                        '17', '18', '19', '20',
                        '21', '22', '23', '24', '25', '26', '27']
                },

                on_off: {
                    acceptReporters: true,
                    items: ['0', '1']
                }
            }
        };
    }

    // The block handlers

    // command blocks

    ip_address(args) {
        if (args['IP_ADDR']) {
            ws_ip_address = args['IP_ADDR'];
            if (!connected) {
                if (!connection_pending) {
                    this.connect();
                    connection_pending = true;
                }
            }

        }

    }

    digital_write(args) {
        if (!connected) {
            if (!connection_pending) {
                this.connect();
                connection_pending = true;
            }

        }

        if (!connected) {
            let callbackEntry = [this.digital_write.bind(this), args];
            wait_open.push(callbackEntry);
        } else {
            let pin = args['PIN'];
            pin = parseInt(pin, 10);

            if (pin_modes[pin] !== DIGITAL_OUTPUT) {
                pin_modes[pin] = DIGITAL_OUTPUT;
                msg = {"command": "set_mode_digital_output", "pin": pin};
                msg = JSON.stringify(msg);
                window.socketr.send(msg);
            }
            let value = args['ON_OFF'];
            value = parseInt(value, 10);
            msg = {"command": "digital_write", "pin": pin, "value": value};
            msg = JSON.stringify(msg);
            window.socketr.send(msg);
        }
    }

    //pwm
    pwm_write(args) {
        if (!connected) {
            if (!connection_pending) {
                this.connect();
                connection_pending = true;
            }
        }

        if (!connected) {
            let callbackEntry = [this.pwm_write.bind(this), args];
            wait_open.push(callbackEntry);
        } else {
            let pin = args['PIN'];
            // maximum value for RPi and Arduino
            let the_max = 1023;
            pin = parseInt(pin, 10);

            let value = args['VALUE'];
            value = parseInt(value, 10);

            // calculate the value based on percentage
            value = the_max * (value / 100);
            value = Math.round(value);
            if (pin_modes[pin] !== PWM) {
                pin_modes[pin] = PWM;
                msg = {"command": "set_mode_pwm", "pin": pin};
                msg = JSON.stringify(msg);
                window.socketr.send(msg);
            }
            msg = {"command": "pwm_write", "pin": pin, "value": value};
            msg = JSON.stringify(msg);
            window.socketr.send(msg);

        }
    }

    tone_on(args) {
        if (!connected) {
            if (!connection_pending) {
                this.connect();
                connection_pending = true;
            }
        }

        if (!connected) {
            let callbackEntry = [this.tone_on.bind(this), args];
            wait_open.push(callbackEntry);
        } else {
            let pin = args['PIN'];
            pin = parseInt(pin, 10);
            let freq = args['FREQ'];
            freq = parseInt(freq, 10);
            let duration = args['DURATION'];
            duration = parseInt(duration, 10);
            // make sure duration maximum is 5 seconds
            if (duration > 5000) {
                duration = 5000;
            }


            if (pin_modes[pin] !== TONE) {
                pin_modes[pin] = TONE;
                msg = {"command": "set_mode_tone", "pin": pin};
                msg = JSON.stringify(msg);
                window.socketr.send(msg);
            }
            msg = {"command": "play_tone", "pin": pin, 'freq': freq, 'duration': duration};
            msg = JSON.stringify(msg);
            window.socketr.send(msg);

        }
    }

    // move servo
    servo(args) {
        if (!connected) {
            if (!connection_pending) {
                this.connect();
                connection_pending = true;
            }
        }
        if (!connected) {
            let callbackEntry = [this.servo.bind(this), args];
            wait_open.push(callbackEntry);
        } else {
            let pin = args['PIN'];
            pin = parseInt(pin, 10);
            let angle = args['ANGLE'];
            angle = parseInt(angle, 10);


            if (pin_modes[pin] !== SERVO) {
                pin_modes[pin] = SERVO;
                msg = {"command": "set_mode_servo", "pin": pin};
                msg = JSON.stringify(msg);
                window.socketr.send(msg);
            }
            msg = {
                'command': 'servo_position', "pin": pin,
                'position': angle
            };
            msg = JSON.stringify(msg);
            window.socketr.send(msg);

        }
    }

    // reporter blocks


    digital_read(args) {
        if (!connected) {
            if (!connection_pending) {
                this.connect();
                connection_pending = true;
            }
        }
        if (!connected) {
            let callbackEntry = [this.digital_read.bind(this), args];
            wait_open.push(callbackEntry);
        } else {
            let pin = args['PIN'];
            pin = parseInt(pin, 10);

            if (pin_modes[pin] !== DIGITAL_INPUT) {
                pin_modes[pin] = DIGITAL_INPUT;
                msg = {"command": "set_mode_digital_input", "pin": pin};
                msg = JSON.stringify(msg);
                window.socketr.send(msg);
            }
            return digital_inputs[pin];

        }
    }

    sonar_read(args) {
        if (!connected) {
            if (!connection_pending) {
                this.connect();
                connection_pending = true;
            }
        }
        if (!connected) {
            let callbackEntry = [this.sonar_read.bind(this), args];
            wait_open.push(callbackEntry);
        } else {
            let trigger_pin = args['TRIGGER_PIN'];
            trigger_pin = parseInt(trigger_pin, 10);
            sonar_report_pin = trigger_pin;
            let echo_pin = args['ECHO_PIN'];
            echo_pin = parseInt(echo_pin, 10);


            if (pin_modes[trigger_pin] !== SONAR) {
                pin_modes[trigger_pin] = SONAR;
                msg = {"command": "set_mode_sonar", "trigger_pin": trigger_pin, "echo_pin": echo_pin};
                msg = JSON.stringify(msg);
                window.socketr.send(msg);
            }
            return digital_inputs[sonar_report_pin];

        }
    }

    _setLocale () {
        let now_locale = '';
        switch (formatMessage.setup().locale){
            case 'pt-br':
            case 'pt':
                now_locale='pt-br';
                break;
            case 'en':
                now_locale='en';
                break;
            case 'fr':
                now_locale='fr';
                break;
            case 'zh-tw':
                now_locale= 'zh-tw';
                break;
            case 'zh-cn':
                now_locale= 'zh-cn';
                break;
            default:
                now_locale='en';
                break;
        }
        return now_locale;
    }

    // end of block handlers

    // helpers
    connect() {
        if (connected) {
            // ignore additional connection attempts
            return;
        } else {
            connect_attempt = true;
            let url = "ws://" + ws_ip_address + ":9001";
            console.log(url);
            //window.socketr = new WebSocket("ws://127.0.0.1:9001");
            window.socketr = new WebSocket(url);
            msg = JSON.stringify({"id": "to_rpi_gateway"});
        }


        // websocket event handlers
        window.socketr.onopen = function () {

            digital_inputs.fill(0);
            analog_inputs.fill(0);
            // connection complete
            connected = true;
            connect_attempt = true;
            // the message is built above
            try {
                //ws.send(msg);
                window.socketr.send(msg);

            } catch (err) {
                // ignore this exception
            }
            for (let index = 0; index < wait_open.length; index++) {
                let data = wait_open[index];
                data[0](data[1]);
            }
        };

        window.socketr.onclose = function () {
            digital_inputs.fill(0);
            analog_inputs.fill(0);
            pin_modes.fill(-1);
            if (alerted === false) {
                alerted = true;
                alert(FormWSClosed[the_locale]);}
            connected = false;
        };

        // reporter messages from the board
        window.socketr.onmessage = function (message) {
            msg = JSON.parse(message.data);
            let report_type = msg["report"];
            let pin = null;
            let value = null;

            // types - digital, analog, sonar
            if (report_type === 'digital_input') {
                pin = msg['pin'];
                pin = parseInt(pin, 10);
                value = msg['value'];
                digital_inputs[pin] = value;
            } else if (report_type === 'analog_input') {
                pin = msg['pin'];
                pin = parseInt(pin, 10);
                value = msg['value'];
                analog_inputs[pin] = value;
            } else if (report_type === 'sonar_data') {
                value = msg['value'];
                digital_inputs[sonar_report_pin] = value;
            }
        };
    }


}

module.exports = Scratch3RpiOneGPIO;
